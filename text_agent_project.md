# ドキュメント変換システム – 詳細仕様書 v1.0

> **目的** 多様な入力ソースを *高可読性日本語テキスト* に統一変換し、機能追加・品質改善・コスト管理を継続的に回せる開発／運用フレームワークを確立する。

---

## 1. 入力仕様

### 1.1 対応フォーマット（初期実装＋YouTube 追加）

| 種別                | 例拡張子／スキーム              | 抽出器プラグイン                   | 補足                   |
| ----------------- | ---------------------- | -------------------------- | -------------------- |
| PDF（デジタル）         | .pdf                   | `marker_pdf`               | 文字レイヤあり              |
| PDF（スキャン）         | .pdf                   | `marker_ocr_pdf`           | OCR 前処理付き            |
| 音声                | .mp3 / .wav / .m4a     | `whisper_large`            | Whisper Large v3     |
| Web ページ           | http/https URL         | `trafilatura_web`          | 本文抽出のみ               |
| **YouTube**       | `https://youtu.be/...` | `youtube_caption_or_audio` | 自動字幕 → Fallback 音声DL |
| 画像 (Phase‑2)      | .png / .jpg            | `ocr_image`                | Tesseract + 文整形      |
| プレインテキスト／Markdown | .txt / .md             | `plain_reader`             | そのまま読み込み             |

> **YouTube 抽出器の仕様**
>
> 1. `yt-dlp` で自動生成字幕（`--write-auto-subs`) を取得。日本語以外 → 翻訳フェーズへ。
> 2. 字幕が取得できない場合 `yt-dlp -x --audio-format mp3` で音声 DL → Whisper 文字起こし。
> 3. メタデータに `{source_type: "youtube", video_id, caption_used: bool}` を付与。

> **拡張ポリシー** 新フォーマットを追加するときは `src/docpipe/extractors/` にプラグイン実装 → `configs/pipeline/` に YAML を追加し、CI を通す。

---

## 2. 出力仕様

| 項目      | 値                                                                                    |
| ------- | ------------------------------------------------------------------------------------ |
| 形式      | UTF‑8 テキストファイル (`*.txt`)                                                             |
| 改行      | 段落単位で 1 空行（Markdown 互換）                                                              |
| ファイル名規約 | `doc_<index>__<slugified‑source>.txt`                                                |
| メタデータ   | `summary.json` に `{ source, source_type, quality_score, tags, pipeline, timestamp }` |

---

## 3. 自動化フロー

```mermaid
flowchart TD
  A[Input Files / URLs] --> B[形式判定]
  B -->|Marker| C1[PDF Extract]
  B -->|Whisper| C2[Audio Transcribe]
  B -->|Trafilatura| C3[Web Extract]
  B -->|YouTube| C4[Caption ▶︎ Whisper Fallback]
  C1 & C2 & C3 & C4 --> D[前処理 / 改行復元・OCR補正]
  D --> E[翻訳 / 校正 (GPT‑4o Proofreader)]
  E --> F[品質評価]
  F -->|score≥閾値| G[分類整理 + 保存]
  F -->|score<閾値 & retry<3| E
  F -->|score<閾値 & retry≥3| H[Fixer Agent → 新アプローチ or 手動確認]
```

> **YouTube ルート詳細**
>
> * 字幕が日本語以外 → 翻訳フェーズで **必ず日本語に翻訳**。
> * Whisper 出力時も同様に翻訳条件を適用。

---

## 4. 開発自動化レベル

| 項目    | 採用ツール / 方針                                                 |
| ----- | ---------------------------------------------------------- |
| テスト生成 | Codex/GPT‑4o でユニットテスト自動生成・実行 ⇒ 緑化まで自動                      |
| CI    | Ruff・MyPy・PyTest・Integration・Quality Gate (GitHub Actions) |
| CD    | main ブランチ緑化 → Docker イメージ / Serverless 関数自動デプロイ            |
| 依存管理  | YouTube 抽出器は `yt-dlp` にピン留め（セキュリティ考慮）                      |

---

## 5. 人間が注力する領域

1. **機能要求追加** 新フォーマット（例：TikTok）・新評価指標・UI 拡張を backlog 化
2. **品質改善** プロンプトと閾値の最適化、コストと精度のトレードオフ調整
3. **主観レビュー** 編集者がサンプリングして可読性をチェック（ペルソナ＝一般読者）

---

## 6. 品質評価と合格基準

| 指標                        | 目標値        | 評価ツール                        | 備考                     |
| ------------------------- | ---------- | ---------------------------- | ---------------------- |
| **LanguageTool 文法エラー率**   | ≤ **2 %**  | `language‑tool‑python`       | total\_errors / tokens |
| **LLM Readability Score** | ≥ **0.85** | GPT-4o evaluator (専用 prompt) | 0–1 実数返却               |
| **BLEU‑ja** (翻訳時)         | ≥ **35**   | `sacrebleu`                  | 原文が非日文の場合のみ            |

* **再試行戦略** 品質 < 閾値 かつ **改善率 ≤ 0.01** で頭打ちの場合に打ち切り。最大試行 3 回。
* **期待読者** 一般層。専門用語には `(Appleのスマートフォン「iPhone」)` のように一括説明を付与。

---

## 7. リスク & ガバナンス

| テーマ      | ポリシー                                              |
| -------- | ------------------------------------------------- |
| 個人情報検出   | 自動マスキング or アラート ⇒ 保留 → 次ループで *ローカルモデル* か *除外* を選択 |
| LLM 送信制限 | 社外秘ドキュメントはローカルモデルのみ使用（config `llm.profile=local`） |
| DPIA     | 現時点不要。必要時に実施できるチェックリストを整備                         |
| 監査ログ     | JSON Lines 保存。保持 **90 日** → 自動削除。アクセス権：運用チームのみ    |

---

## 8. SLA & コスト管理

| 指標        | 目標値 / 運用方針                               |
| --------- | ---------------------------------------- |
| スループット    | **60 ドキュメント/時**（YouTube 字幕有の場合を含む）       |
| レイテンシ     | 1 ドキュメント **≤ 5 分**（YouTube 音声 20 分以内を前提） |
| 月間 API 予算 | **500 USD** 固定                           |
| コストアラート   | 使用率 \*\*80 %\*\*で Slack 通知 → 継続実行可否を確認   |
| モデル切替     | デフォルトモデル → 品質低の場合に 1 ランク上へ自動引上げ          |

---

## 9. 可観測性

| 要素      | 詳細                                  |
| ------- | ----------------------------------- |
| メトリクス   | 処理件数・平均品質・失敗率・API コスト・YouTube 字幕使用率 |
| トレース ID | **ファイル／動画単位** で UUID 付与             |
| ダッシュボード | Prometheus + Grafana                |
| アラート    | Slack (PagerDuty 無し)                |
| SLO 未達  | 別アプローチで再処理 → それでも改善しなければ手動レビュー      |

---

## 10. モデル／ツール ライフサイクル

| 項目      | 方針                                                                        |
| ------- | ------------------------------------------------------------------------- |
| A/B テスト | 半年ごと or 新モデル検知時に実施。**サンプル 200 文書/動画** または **1 日分** の大きい方。期間は任意実行→合格判定で昇格。 |
| 合格基準    | 品質スコアが現行比 **+0.02** 以上 または コスト **‑10 %** 以上改善                             |
| ロールバック  | 品質 **‑0.02** 悪化で自動戻し。マイナーアップデートは **手動承認**。                                |
| バージョン固定 | Whisper Large (ローカル) 依存の Python 🡒 CI で整合性チェック                            |

---

## 11. UX & インターフェース

| フェーズ    | インターフェース                        | 主要機能                               |
| ------- | ------------------------------- | ---------------------------------- |
| Phase‑1 | **CLI** (`docpipe run inputs/`) | プロファイル切替・統計表示・コスト表示・YouTube URL 対応 |
| Phase‑2 | **Web UI (Streamlit)**          | D\&D / URL入力 / API Key 入力・実行履歴表示   |
